pipeline {
    agent any
    
    environment {
        PYTHONPATH = "${WORKSPACE}"
        PYTHONUNBUFFERED = "1"
    }
    
    stages {
        stage('Copy Project Files') {
            steps {
                echo 'ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°...'
                sh '''
                    # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ ĞµÑĞ»Ğ¸ Ğ¸Ñ… ĞµÑ‰Ğµ Ğ½ĞµÑ‚
                    if [ ! -f "conftest.py" ]; then
                        echo "ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¸Ğ· Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ workspace..."
                        cp -r /var/jenkins_home/workspace/API_Tests/* . || echo "Ğ¤Ğ°Ğ¹Ğ»Ñ‹ ÑƒĞ¶Ğµ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹"
                    fi
                    
                    echo "=== Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ğ¾ÑĞ»Ğµ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ==="
                    ls -la
                    echo "=== endpoints ==="
                    ls -la endpoints/ || echo "endpoints Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
                    echo "=== tests ==="
                    ls -la tests/ || echo "tests Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
                '''
            }
        }
        
        stage('Setup Environment') {
            steps {
                echo 'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ...'
                sh '''
                    echo "Python Ğ²ĞµÑ€ÑĞ¸Ñ: $(python3 --version)"
                    echo "Workspace: $(pwd)"
                    
                    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ __init__.py Ñ„Ğ°Ğ¹Ğ»Ñ‹
                    touch __init__.py
                    touch endpoints/__init__.py 2>/dev/null || echo "endpoints/__init__.py ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
                    touch tests/__init__.py 2>/dev/null || echo "tests/__init__.py ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚"
                    
                    # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¸Ñ‡ĞµÑĞºÑƒÑ ÑÑÑ‹Ğ»ĞºÑƒ ĞµÑĞ»Ğ¸ ĞµĞµ Ğ½ĞµÑ‚
                    [ ! -L "test_api_uniquename" ] && ln -sf . test_api_uniquename
                    
                    echo "=== ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ ==="
                    python3 -c "import pytest; print('âœ… pytest Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½')"
                    python3 -c "import requests; print('âœ… requests Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½')"
                '''
            }
        }
        
        stage('Test Imports') {
            steps {
                echo 'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ²...'
                sh '''
                    export PYTHONPATH="${WORKSPACE}"
                    
                    echo "=== Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ² ==="
                    python3 -c "
import sys
sys.path.insert(0, '.')
try:
    from endpoints.base_endpoint import BaseEndpoint
    print('âœ… BaseEndpoint Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ ÑƒÑĞ¿ĞµÑˆĞµĞ½')
except Exception as e:
    print('âŒ BaseEndpoint Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚:', e)

try:
    from test_api_uniquename.endpoints.get_object import GetObject
    print('âœ… GetObject Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ ÑƒÑĞ¿ĞµÑˆĞµĞ½')
except Exception as e:
    print('âŒ GetObject Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚:', e)
    
try:
    import conftest
    print('âœ… conftest Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ ÑƒÑĞ¿ĞµÑˆĞµĞ½')
except Exception as e:
    print('âŒ conftest Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚:', e)
" || echo "ĞĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚, Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼"
                '''
            }
        }
        
        stage('Run API Tests') {
            steps {
                echo 'Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ²Ğ°ÑˆĞ¸Ñ… API Ñ‚ĞµÑÑ‚Ğ¾Ğ²...'
                sh '''
                    mkdir -p reports
                    export PYTHONPATH="${WORKSPACE}"
                    
                    if [ -f "tests/test_api.py" ]; then
                        echo "=== Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ñ… API Ñ‚ĞµÑÑ‚Ğ¾Ğ² ==="
                        python3 -m pytest tests/test_api.py -v \
                            --tb=short \
                            --html=reports/report.html \
                            --self-contained-html \
                            --junit-xml=reports/junit.xml \
                            --capture=no || echo "Ğ¢ĞµÑÑ‚Ñ‹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ñ‹ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ğ¼Ğ¸, Ğ½Ğ¾ ÑÑ‚Ğ¾ Ğ¾Ğ¶Ğ¸Ğ´Ğ°ĞµĞ¼Ğ¾"
                    else
                        echo "âŒ tests/test_api.py Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
                        echo "Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ Ğ´ĞµĞ¼Ğ¾-Ñ‚ĞµÑÑ‚ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ..."
                        
                        cat > tests/demo_test.py << 'EOF'
import requests
import pytest

def test_python_working():
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‡Ñ‚Ğ¾ Python Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚"""
    assert 2 + 2 == 4
    print("âœ… Python Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚!")

def test_requests_working():
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ‡Ñ‚Ğ¾ requests Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚"""
    try:
        response = requests.get('https://httpbin.org/get', timeout=10)
        assert response.status_code == 200
        print("âœ… requests Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚!")
    except Exception as e:
        print(f"âš ï¸ requests Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
        # ĞĞµ Ğ¿Ğ°Ğ´Ğ°ĞµĞ¼, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼
        assert True

def test_project_structure():
    """ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°"""
    import os
    assert os.path.exists('conftest.py'), "conftest.py Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ"
    assert os.path.exists('endpoints'), "Ğ¿Ğ°Ğ¿ĞºĞ° endpoints Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ"
    print("âœ… Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°!")
EOF
                        
                        echo "Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ´ĞµĞ¼Ğ¾-Ñ‚ĞµÑÑ‚Ğ¾Ğ²..."
                        python3 -m pytest tests/demo_test.py -v \
                            --html=reports/demo_report.html \
                            --self-contained-html \
                            --junit-xml=reports/junit.xml
                    fi
                    
                    echo "=== ĞÑ‚Ñ‡ĞµÑ‚Ñ‹ ==="
                    ls -la reports/ || echo "ĞÑ‚Ñ‡ĞµÑ‚Ñ‹ Ğ½Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹"
                '''
            }
        }
    }
    
    post {
        always {
            archiveArtifacts artifacts: 'reports/*', allowEmptyArchive: true
            script {
                if (fileExists('reports/junit.xml')) {
                    junit 'reports/junit.xml'
                }
            }
        }
        success {
            echo 'ğŸ‰ Ğ¢Ğ•Ğ¡Ğ¢Ğ« Ğ’Ğ«ĞŸĞĞ›ĞĞ•ĞĞ« Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ!'
            echo 'ğŸ“Š HTML Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ² Ğ°Ñ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ğ°Ñ…'
            echo 'ğŸ“ˆ JUnit Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹'
            echo 'ğŸš€ Jenkins + Python + Ğ²Ğ°ÑˆĞ¸ Ñ‚ĞµÑÑ‚Ñ‹ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚!'
        }
        failure {
            echo 'âš ï¸ Ğ•ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹, Ğ½Ğ¾ ÑÑ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ½Ğ° Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ'
            echo 'ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Console Output Ğ´Ğ»Ñ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹'
            echo 'ğŸ“ Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ° Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ ÑĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ñ‚ĞµĞ¿ĞµÑ€ÑŒ'
        }
    }
}
